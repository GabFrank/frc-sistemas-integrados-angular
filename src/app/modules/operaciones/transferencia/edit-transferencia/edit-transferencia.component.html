<app-generic-list
  titulo="Gestión de Transferencia"
  style="height: 90%"
  [data]="dataSource.data"
  [isLastPage]="isLastPage"
  [isMenu]="false"
>
  <div filtros style="width: 100%; height: 100%">
    <div fxLayout="column" fxLayoutGap="10px" style="height: 100%; width: 100%">
      <div fxFlex fxLayout="row">
        <div fxFlex="25" fxLayout="column">
          <div class="title" fxFlex="50">Id</div>
          <div class="item" fxFlex="50">
            {{ selectedTransferencia?.id }}
          </div>
        </div>
        <div fxFlex="25" fxLayout="column">
          <div class="title" fxFlex="50">Responsable</div>
          <div fxFlex="50">
            {{ selectedResponsable?.persona?.nombre | uppercase }}
          </div>
        </div>
        <div fxFlex="25" fxLayout="column">
          <div class="title" fxFlex="50">Creado En</div>
          <div fxFlex="50">
            {{ selectedTransferencia?.creadoEn | date : "short" }}
          </div>
        </div>
        <div fxFlex="25" fxLayout="column">
          <div class="title" fxFlex="50">Estado</div>
          <div fxFlex="50">
            {{ selectedTransferencia?.estado | enumToString | titlecase }}
          </div>
        </div>
      </div>
      <div fxFlex fxLayout="row">
        <div fxFlex="25" fxLayout="column">
          <div class="title" fxFlex="50">Suc. Origen</div>
          <div class="item" fxFlex="50">
            {{ selectedTransferencia?.sucursalOrigen?.id }} -
            {{ selectedTransferencia?.sucursalOrigen?.nombre | uppercase }}
          </div>
        </div>
        <div fxFlex="25" fxLayout="column">
          <div class="title" fxFlex="50">Suc. Destino</div>
          <div class="item" fxFlex="50">
            {{ selectedTransferencia?.sucursalDestino?.id }} -
            {{ selectedTransferencia?.sucursalDestino?.nombre | uppercase }}
          </div>
        </div>
        <div fxFlex="25" fxLayout="column">
          <div class="title" fxFlex="50">Tipo</div>
          <div class="item" fxFlex="50">
            {{ selectedTransferencia?.tipo }}
          </div>
        </div>
        <div fxFlex="25" fxLayout="column">
          <div class="title" fxFlex="50">Etapa actual</div>
          <div class="item" fxFlex="50">
            {{ selectedTransferencia?.etapa }}
          </div>
        </div>
      </div>

      <div
        fxFlex
        fxLayout="row"
        fxLayoutGap="10px"
        fxLayoutAlign="start center"
      >
        <div
          fxFlex="70%"
          fxLayout="row"
          fxLayoutGap="25px"
          style="width: 100%"
          fxLayoutAlign="start center"
        >
          <div
            *ngIf="selectedTransferencia?.id != null"
            class="raised-button"
            (click)="onQrClick()"
          >
            Generar QR
          </div>
          <div
            *ngIf="selectedTransferencia?.id != null"
            class="raised-button"
            (click)="onImprimir()"
          >
            Imprimir
          </div>
          <div
            *ngIf="selectedTransferencia?.id != null"
            class="raised-button"
            (click)="onRefresh()"
          >
            Actualizar
          </div>
          <div
            *ngIf="selectedTransferencia?.id != null"
            class="raised-button"
            (click)="onOpenTimeLine()"
          >
            Resumen de la transf.
          </div>
          <div class="raised-button" (click)="nuevaTransferencia()">
            Nueva Transferencia
          </div>
          <!-- <mat-form-field class="shrinking-mat-form-field">
            <input
              #cantidadInput
              type="text"
              matInput
              [formControl]="sizeControl"
              style="text-align: center"
              (keyup.enter)="onCantidadItensFocusOut()"
              (click)="cantidadInput.select()"
            />
            <span matTextPrefix>Ver itens:</span>
            <span matTextSuffix>
              <mat-icon
                class="raised-button"
                (click)="onCantidadItensFocusOut()"
                style="transform: translateY(-5px) !important"
                matTooltip="Recargar itens"
                >refresh</mat-icon
              >
            </span>
          </mat-form-field> -->
        </div>
        <div fxFlex="15%">
          <button
            *ngIf="
              isPreTransferenciaCreacion ||
              isPreTransferenciaOrigen ||
              isPreparacionMercaderia
            "
            style="width: 100%"
            mat-raised-button
            (click)="selectSucursales()"
          >
            {{
              selectedTransferencia?.id == null
                ? "Selec. Sucursales"
                : "Cambiar Sucursales"
            }}
          </button>
        </div>
        <div fxFlex="15%" *ngIf="false">
          <button
            *ngIf="isPreTransferenciaCreacion"
            style="width: 100%"
            mat-raised-button
            color="primary"
            (click)="onAddItem()"
          >
            + Producto (F9)
          </button>
        </div>
        <div fxFlex="15%" *ngIf="isPreTransferenciaCreacion">
          <button
            style="width: 100%"
            mat-raised-button
            color="accent"
            (click)="onFinalizar()"
            [disabled]="dataSource.data.length == 0"
          >
            Finalizar
          </button>
        </div>
        <div fxFlex="15%" *ngIf="isPreTransferenciaOrigen && isOrigen">
          <button
            style="width: 100%"
            mat-raised-button
            color="accent"
            (click)="onAvanzarEtapa('PREPARACION_MERCADERIA')"
            [disabled]="dataSource.data.length == 0"
          >
            Preparar para envio
          </button>
        </div>
        <div fxFlex="15%" *ngIf="isPreparacionMercaderia && puedeEditar">
          <button
            style="width: 100%"
            mat-raised-button
            color="accent"
            (click)="onAvanzarEtapa('PREPARACION_MERCADERIA_CONCLUIDA')"
            [disabled]="!isAllConfirmedPreparacion"
          >
            Finalizar
          </button>
        </div>
        <div fxFlex="15%" *ngIf="isPreparacionMercaderiaConcluida">
          <button
            style="width: 100%"
            mat-raised-button
            color="accent"
            (click)="onAvanzarEtapa('TRANSPORTE_VERIFICACION')"
          >
            Verificar para transporte
          </button>
        </div>
        <div fxFlex="15%" *ngIf="isTransporteVerificacion && puedeEditar">
          <button
            style="width: 100%"
            mat-raised-button
            color="accent"
            (click)="onAvanzarEtapa('TRANSPORTE_EN_CAMINO')"
            [disabled]="!isAllConfirmedTransporte"
          >
            Iniciar transporte
          </button>
        </div>
        <div
          fxFlex="15%"
          *ngIf="(isTransporteEnCamino || isTransporteEnDestino) && isDestino"
        >
          <button
            style="width: 100%"
            mat-raised-button
            color="accent"
            (click)="onAvanzarEtapa('RECEPCION_EN_VERIFICACION')"
          >
            Iniciar Recepción
          </button>
        </div>
        <div
          fxFlex="15%"
          *ngIf="isRecepcionEnVerificacion && isDestino && puedeEditar"
        >
          <button
            style="width: 100%"
            mat-raised-button
            color="accent"
            (click)="onAvanzarEtapa('RECEPCION_CONCLUIDA')"
            [disabled]="!isAllConfirmedRecepcion"
          >
            Finalizar
          </button>
        </div>
      </div>
      <mat-card
        appearance="outlined"
        fxFlex
        fxLayout="column"
        style="width: 100%; height: 100%"
        fxLayoutGap="10px"
        style="background-color: rgb(66, 66, 66); padding: 10px"
        *ngIf="isPreTransferenciaCreacion"
      >
        <div
          fxFlex
          fxLayout="row"
          style="width: 100%"
          fxLayoutGap="10px"
          fxLayoutAlign="start center"
        >
          <!-- <div fxFlex="5%" style="text-align: center">
            <img
              [src]="
                presentacionControl.value?.imagenPrincipal != null
                  ? presentacionControl.value?.imagenPrincipal
                  : 'assets/no-image.png'
              "
              style="width: 50px; height: 50px; object-fit: contain"
            />
          </div> -->
          <div fxFlex="30" fxLayout="column" fxLayoutAlign="center start">
            <div style="width: 100%; text-align: center">Producto</div>
            <div style="color: white; font-size: medium">
              {{ selectedProducto?.id }}
              <span *ngIf="selectedProducto.id !== undefined"> - </span>
              {{ selectedProducto?.descripcion | uppercase }}
            </div>
            <div style="color: rgb(177, 177, 177); font-size: small">
              {{ selectedProducto?.descripcionFactura | uppercase }}
            </div>
          </div>
          <div fxFlex="20%">
            <mat-form-field
              style="width: 100%"
              appearance="outline"
              class="shrinking-mat-form-field"
              floatLabel="always"
            >
              <mat-label>Código de barra</mat-label>
              <input
                #codigoInput
                matInput
                type="text"
                [formControl]="codigoControl"
                (keyup.enter)="onSearchPorCodigo()"
                (keyup.tab)="onSearchPorCodigo()"
                (focusin)="onCodigoFocus()"
              />
            </mat-form-field>
          </div>
          <div fxFlex="10%">
            <mat-form-field
              style="width: 100%; text-align: center"
              appearance="outline"
              class="shrinking-mat-form-field"
              floatLabel="always"
            >
              <mat-label>Present.</mat-label>
              <mat-select
                #matSelect
                [formControl]="presentacionControl"
                name="presentacion"
                (keyup.enter)="onPresentacionSelect(); $event.stopPropagation()"
              >
                <mat-option
                  *ngFor="let presentacion of selectedProducto?.presentaciones"
                  [value]="presentacion"
                >
                  {{ presentacion?.cantidad | number : "1.0-3" }}
                </mat-option>
              </mat-select>
            </mat-form-field>
          </div>
          <div fxFlex="10%">
            <mat-form-field
              style="width: 100%; text-align: center"
              appearance="outline"
              class="shrinking-mat-form-field"
              floatLabel="always"
            >
              <mat-label>Cant. por present.</mat-label>
              <input
                #cantPresentacionInput
                matInput
                type="text"
                [formControl]="cantidadPresentacionControl"
                (keyup.enter)="onCantidadPresentacionEnter()"
                (keyup.tab)="onCantidadPresentacionEnter()"
                (focusout)="onCantidadPresentacionFocusOut()"
              />
            </mat-form-field>
          </div>
          <div fxFlex="10%">
            <mat-form-field
              style="width: 100%; text-align: center"
              appearance="outline"
              class="shrinking-mat-form-field"
              floatLabel="always"
            >
              <mat-label>Cant. por unid.</mat-label>
              <input
                #cantUnidadInput
                matInput
                type="text"
                [formControl]="cantidadUnidadControl"
                (keyup.enter)="onCantidadUnidadEnter()"
                (keyup.tab)="onCantidadUnidadEnter()"
              />
            </mat-form-field>
          </div>
          <div fxFlex="10">
            <mat-form-field
              style="width: 100%"
              appearance="outline"
              class="shrinking-mat-form-field"
              floatLabel="always"
            >
              <mat-label>Vencimiento</mat-label>
              <input
                matInput
                #vencimientoInput
                [matDatepicker]="picker"
                [formControl]="vencimientoControl"
                (keyup.enter)="onVencimientoEnter()"
              />
              <mat-datepicker-toggle
                matSuffix
                [for]="picker"
              ></mat-datepicker-toggle>
              <mat-datepicker
                #picker
                (closed)="onDatepickerClosed()"
              ></mat-datepicker>
            </mat-form-field>
          </div>
          <div fxFlex style="width: 100%; text-align: center">
            <mat-icon
              class="highlight-hover"
              (click)="onSave()"
              style="font-size: 2em"
              >save</mat-icon
            >
          </div>

          <div fxFlex style="width: 100%; text-align: center">
            <mat-icon
              class="highlight-hover-danger"
              (click)="onClear()"
              style="font-size: 2em"
              >clear</mat-icon
            >
          </div>
        </div>
        <div
          *ngIf="
            selectedTransferencia.sucursalOrigen?.nombre?.includes('COMPRAS')
          "
          fxFlex
          fxLayout="row"
          style="width: 100%"
          fxLayoutGap="10px"
        >
          <div fxFlex="15"></div>
          <div fxFlex="15"></div>
          <div fxFlex="15">
            <mat-form-field
              style="width: 100%"
              appearance="outline"
              class="shrinking-mat-form-field"
              floatLabel="always"
            >
              <mat-label>Moneda</mat-label>
              <input
                #monedaInput
                type="text"
                matInput
                [formControl]="monedaControl"
                oninput="this.value == ' ' ? this.value = '': null"
                [matAutocomplete]="autoMoneda"
              />
              <span matSuffix style="cursor: pointer">(F9)</span>

              <mat-autocomplete
                #autoMoneda="matAutocomplete"
                (optionSelected)="onMonedaSelect($event.option.value)"
                (closed)="onMonedaAutocompleteClose()"
              >
                <mat-option
                  *ngFor="let moneda of filteredMonedaList"
                  [value]="moneda"
                >
                  {{ moneda.id }} -
                  {{ moneda?.denominacion | uppercase }}
                </mat-option>
              </mat-autocomplete>
            </mat-form-field>
          </div>
          <div fxFlex="10%">
            <mat-form-field
              style="width: 100%"
              appearance="outline"
              class="shrinking-mat-form-field"
              floatLabel="always"
            >
              <mat-label>Costo por unid.</mat-label>
              <input
                #precioUnidadInput
                matInput
                type="text"
                [formControl]="precioUnidadControl"
                (keyup.enter)="onPrecioUnidadEnter()"
                (keyup.tab)="onPrecioUnidadEnter()"
                currencyMask
                [options]="currencyMask.currencyOptionsGuarani"
              />
            </mat-form-field>
          </div>
          <div fxFlex="10%">
            <mat-form-field
              style="width: 100%"
              appearance="outline"
              class="shrinking-mat-form-field"
              floatLabel="always"
            >
              <mat-label>Costo por present.</mat-label>
              <input
                #precioPresentacionInput
                matInput
                type="text"
                [formControl]="precioPresentacionControl"
                (keyup.enter)="onPrecioPresentacionEnter()"
                (keyup.tab)="onPrecioPresentacionEnter()"
                currencyMask
                [options]="currencyMask.currencyOptionsGuarani"
              />
            </mat-form-field>
          </div>
        </div>
      </mat-card>
    </div>
  </div>

  <div
    table
    style="height: 100%; background-color: rgb(70, 70, 70)"
    fxLayout="column"
    fxLayoutAlign="space-between start"
  >
    <table
      *ngIf="isPreTransferenciaCreacion"
      mat-table
      [dataSource]="dataSource"
      multiTemplateDataRows
      class="mat-elevation-z8"
    >
      <ng-container matColumnDef="producto">
        <th mat-header-cell *matHeaderCellDef style="width: 30%">
          <div fxLayout="row" fxLayoutAlign="start space-between">
            <div fxFlex="90" fxLayout="column" fxLayoutAlign="center start">
              <span *ngIf="!filtroProductosOpen"> Producto </span>
              <span *ngIf="filtroProductosOpen" style="width: 100%">
                <div>
                  <mat-form-field
                    style="width: 100%"
                    appearance="outline"
                    class="shrinking-mat-form-field"
                  >
                    <input
                      #filtroProductoInput
                      matInput
                      type="text"
                      [formControl]="filtroProductoControl"
                      (keyup.enter)="onFilterProducto()"
                      (keyup.tab)="onSearchPorCodigo()"
                      (focusin)="filtroProductoInput.select()"
                    />
                  </mat-form-field>
                </div>
              </span>
            </div>
            <div fxFlex="10">
              <span *ngIf="!filtroProductosOpen">
                <button mat-icon-button (click)="abrirFiltroProductos()">
                  <mat-icon>search</mat-icon>
                </button>
              </span>
              <span *ngIf="filtroProductosOpen">
                <button mat-icon-button (click)="abrirFiltroProductos()">
                  <mat-icon>clear</mat-icon>
                </button>
              </span>
            </div>
          </div>
        </th>
        <td mat-cell *matCellDef="let item" style="width: 30%">
          <span copiarAClipboard>{{
            item?.presentacionPreTransferencia?.producto?.id
          }}</span>
          -
          <span copiarAClipboard>{{
            item?.presentacionPreTransferencia?.producto?.descripcion
              | uppercase
          }}</span>
        </td>
      </ng-container>

      <ng-container matColumnDef="codigo">
        <th mat-header-cell *matHeaderCellDef>Cod. Barra</th>
        <td mat-cell *matCellDef="let item" copiarAClipboard>
          {{ item?.presentacionPreTransferencia?.producto?.codigoPrincipal }}
        </td>
      </ng-container>

      <ng-container matColumnDef="presentacion">
        <th mat-header-cell *matHeaderCellDef style="text-align: center">
          Presentacion
        </th>
        <td mat-cell *matCellDef="let item" style="text-align: center">
          {{ item?.presentacionPreTransferencia?.cantidad | number : "1.0-3" }}
        </td>
      </ng-container>

      <ng-container matColumnDef="cantidad">
        <th mat-header-cell *matHeaderCellDef style="text-align: center">
          Cantidad
        </th>
        <td mat-cell *matCellDef="let item" style="text-align: center">
          {{ item?.cantidadPreTransferencia | number : "1.0-3" }}
        </td>
      </ng-container>

      <ng-container matColumnDef="precio">
        <th mat-header-cell *matHeaderCellDef style="text-align: center">
          Precio venta
        </th>
        <td
          mat-cell
          *matCellDef="let item"
          style="text-align: center"
          [copiarAClipboard]="
            item?.presentacionPreTransferencia?.precioPrincipal?.precio
          "
        >
          {{
            item?.presentacionPreTransferencia?.precioPrincipal?.precio
              | number : "1.0-3"
          }}
        </td>
      </ng-container>

      <ng-container matColumnDef="vencimiento">
        <th mat-header-cell *matHeaderCellDef style="text-align: center">
          Vencimiento
        </th>
        <td
          mat-cell
          *matCellDef="let item"
          style="text-align: center; height: 100%"
        >
          <div
            fxLayout="row"
            style="width: 100%; height: 100%"
            fxLayoutGap="10px"
          >
            <div fxFlex>
              {{ item?.vencimientoPreTransferencia | date : "shortDate" }}
            </div>
          </div>
        </td>
      </ng-container>

      <ng-container matColumnDef="estado">
        <th mat-header-cell *matHeaderCellDef style="text-align: center">
          Estado
        </th>
        <td mat-cell *matCellDef="let item" style="text-align: center">
          Falta verificar
        </td>
      </ng-container>

      <ng-container matColumnDef="menu">
        <th
          mat-header-cell
          *matHeaderCellDef
          style="width: 5%; text-align: center"
        ></th>
        <td
          mat-cell
          *matCellDef="let item; let itemIndex = dataIndex"
          style="width: 5%; text-align: center"
        >
          <button
            mat-icon-button
            [matMenuTriggerFor]="menu"
            (click)="$event.stopPropagation()"
          >
            <mat-icon>more_vert</mat-icon>
          </button>
          <mat-menu #menu="matMenu">
            <button
              mat-menu-item
              (click)="onEditItem(item)"
              [disabled]="isPreparacionMercaderia && puedeEditar"
            >
              Editar
            </button>
            <button
              mat-menu-item
              (click)="onDeleteItem(item, itemIndex)"
              style="color: red"
              [disabled]="isPreparacionMercaderia"
            >
              Eliminar
            </button>
          </mat-menu>
        </td>
      </ng-container>

      <!-- Expanded Content Column - The detail row is made up of this one column that spans across all columns -->
      <ng-container matColumnDef="expandedDetail">
        <td
          mat-cell
          *matCellDef="let element"
          [attr.colspan]="columnsToDisplay.length"
        >
          <div
            class="example-element-detail"
            [@detailExpand]="
              element == expandedElement ? 'expanded' : 'collapsed'
            "
          ></div>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="columnsToDisplay"></tr>
      <tr
        mat-row
        *matRowDef="let element; columns: columnsToDisplay"
        class="example-element-row"
        [class.example-expanded-row]="expandedElement === element"
        (click)="expandedElement = expandedElement === element ? null : element"
      ></tr>
      <tr
        mat-row
        *matRowDef="let row; columns: ['expandedDetail']"
        class="example-detail-row"
      ></tr>
    </table>

    <table
      *ngIf="isPreTransferenciaOrigen || isPreparacionMercaderia"
      mat-table
      [dataSource]="dataSource"
      multiTemplateDataRows
      class="mat-elevation-z8"
    >
      <ng-container matColumnDef="producto">
        <th mat-header-cell *matHeaderCellDef style="width: 30%">
          <div fxLayout="row" fxLayoutAlign="start space-between">
            <div fxFlex="90" fxLayout="column" fxLayoutAlign="center start">
              <span *ngIf="!filtroProductosOpen"> Producto </span>
              <span *ngIf="filtroProductosOpen" style="width: 100%">
                <div>
                  <mat-form-field
                    style="width: 100%"
                    appearance="outline"
                    class="shrinking-mat-form-field"
                  >
                    <input
                      #filtroProductoInput
                      matInput
                      type="text"
                      [formControl]="filtroProductoControl"
                      (keyup.enter)="onFilterProducto()"
                      (keyup.tab)="onSearchPorCodigo()"
                      (focusin)="filtroProductoInput.select()"
                    />
                  </mat-form-field>
                </div>
              </span>
            </div>
            <div fxFlex="10">
              <span *ngIf="!filtroProductosOpen">
                <button mat-icon-button (click)="abrirFiltroProductos()">
                  <mat-icon>search</mat-icon>
                </button>
              </span>
              <span *ngIf="filtroProductosOpen">
                <button mat-icon-button (click)="abrirFiltroProductos()">
                  <mat-icon>clear</mat-icon>
                </button>
              </span>
            </div>
          </div>
        </th>        <td mat-cell *matCellDef="let item" style="width: 30%">
          {{ item?.presentacionPreTransferencia?.producto?.id }} -
          {{
            item?.presentacionPreTransferencia?.producto?.descripcion
              | uppercase
          }}
        </td>
      </ng-container>

      <ng-container matColumnDef="codigo">
        <th mat-header-cell *matHeaderCellDef>Cod. Barra</th>
        <td mat-cell *matCellDef="let item">
          {{ item?.presentacionPreTransferencia?.producto?.codigoPrincipal }}
        </td>
      </ng-container>

      <ng-container matColumnDef="presentacion">
        <th mat-header-cell *matHeaderCellDef style="text-align: center">
          Presentacion
        </th>
        <td mat-cell *matCellDef="let item" style="text-align: center">
          {{ item?.presentacionPreTransferencia?.cantidad | number : "1.0-3" }}
        </td>
      </ng-container>

      <ng-container matColumnDef="cantidad">
        <th mat-header-cell *matHeaderCellDef style="text-align: center">
          Cantidad
        </th>
        <td mat-cell *matCellDef="let item" style="text-align: center">
          {{ item?.cantidadPreTransferencia | number : "1.0-3" }}
          {{
            item?.motivoModificacionPreparacion == "CANTIDAD_INCORRECTA"
              ? " / " + item?.cantidadPreparacion
              : null
          }}
        </td>
      </ng-container>

      <ng-container matColumnDef="precio">
        <th mat-header-cell *matHeaderCellDef style="text-align: center">
          Precio venta
        </th>
        <td mat-cell *matCellDef="let item" style="text-align: center">
          {{
            item?.presentacionPreTransferencia?.precioPrincipal?.precio
              | number : "1.0-2"
          }}
        </td>
      </ng-container>

      <ng-container matColumnDef="vencimiento">
        <th mat-header-cell *matHeaderCellDef style="text-align: center">
          Vencimiento
        </th>
        <td
          mat-cell
          *matCellDef="let item"
          style="text-align: center; height: 100%"
        >
          <div
            fxLayout="row"
            style="width: 100%; height: 100%"
            fxLayoutGap="10px"
          >
            <div fxFlex>
              {{ item?.vencimientoPreTransferencia | date : "shortDate" }}
            </div>
            <div
              fxFlex="10"
              *ngIf="
                item?.motivoModificacionPreparacion == 'VENCIMIENTO_INCORRECTO'
              "
            >
              -
            </div>
            <div
              fxFlex
              *ngIf="
                item?.motivoModificacionPreparacion == 'VENCIMIENTO_INCORRECTO'
              "
            >
              {{ item?.vencimientoPreparacion | date : "shortDate" }}
            </div>
          </div>
        </td>
      </ng-container>

      <ng-container matColumnDef="estado">
        <th mat-header-cell *matHeaderCellDef style="text-align: center">
          Estado
        </th>
        <td mat-cell *matCellDef="let item" style="text-align: center">
          {{
            item?.cantidadPreparacion != null ||
            item?.vencimientoPreparacion != null ||
            item?.motivoRechazoPreparacion != null
              ? "Verificado"
              : "Falta verificar"
          }}
        </td>
      </ng-container>

      <ng-container matColumnDef="menu">
        <th
          mat-header-cell
          *matHeaderCellDef
          style="width: 5%; text-align: center"
        ></th>
        <td
          mat-cell
          *matCellDef="let item; let i = tabIndex"
          style="width: 5%; text-align: center"
        >
          <button
            mat-icon-button
            [matMenuTriggerFor]="menu"
            (click)="$event.stopPropagation()"
            [disabled]="!isPreparacionMercaderia || !puedeEditar"
          >
            <mat-icon>more_vert</mat-icon>
          </button>
          <mat-menu #menu="matMenu">
            <button
              mat-menu-item
              color="accent"
              (click)="onConfirm(item)"
              *ngIf="isPreparacionMercaderia"
            >
              Confirmar
            </button>
            <button
              mat-menu-item
              *ngIf="
                item.cantidadPreparacion != null ||
                item.vencimientoPreparacion != null ||
                item.motivoRechazoPreparacion != null
              "
              color="primary"
              (click)="onDesconfirm(item)"
            >
              Desconfirmar
            </button>
            <button mat-menu-item (click)="onModificarCantidad(item)">
              Modificar cantidad
            </button>
            <button mat-menu-item (click)="onModificarVencimiento(item)">
              Modificar vencimiento
            </button>
            <button mat-menu-item (click)="onRechazar(item)">
              Rechazar item
            </button>
          </mat-menu>
        </td>
      </ng-container>

      <!-- Expanded Content Column - The detail row is made up of this one column that spans across all columns -->
      <ng-container matColumnDef="expandedDetail">
        <td
          mat-cell
          *matCellDef="let element"
          [attr.colspan]="columnsToDisplay.length"
        >
          <div
            class="example-element-detail"
            [@detailExpand]="
              element == expandedElement ? 'expanded' : 'collapsed'
            "
          >
            <div>{{ element?.cantidadPreparacion | number : "1.0-3" }}</div>
          </div>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="columnsToDisplay"></tr>
      <tr
        mat-row
        *matRowDef="let element; columns: columnsToDisplay"
        class="example-element-row"
        [class.example-expanded-row]="expandedElement === element"
        (click)="expandedElement = expandedElement === element ? null : element"
        [class.sin-cambios]="
          element.cantidadPreparacion != null &&
          element.motivoModificacionPreparacion == null &&
          element.motivoRechazoPreparacion == null
        "
        [class.con-cambios]="element.motivoModificacionPreparacion != null"
        [class.rechazado]="element.motivoRechazoPreparacion != null"
      ></tr>
      <tr
        mat-row
        *matRowDef="let row; columns: ['expandedDetail']"
        class="example-detail-row"
      ></tr>
    </table>

    <table
      *ngIf="
        isPreparacionMercaderiaConcluida ||
        isTransporteVerificacion ||
        isTransporteEnCamino
      "
      mat-table
      [dataSource]="dataSource"
      multiTemplateDataRows
      class="mat-elevation-z8"
    >
      <ng-container matColumnDef="producto">
        <th mat-header-cell *matHeaderCellDef style="width: 30%">
          <div fxLayout="row" fxLayoutAlign="start space-between">
            <div fxFlex="90" fxLayout="column" fxLayoutAlign="center start">
              <span *ngIf="!filtroProductosOpen"> Producto </span>
              <span *ngIf="filtroProductosOpen" style="width: 100%">
                <div>
                  <mat-form-field
                    style="width: 100%"
                    appearance="outline"
                    class="shrinking-mat-form-field"
                  >
                    <input
                      #filtroProductoInput
                      matInput
                      type="text"
                      [formControl]="filtroProductoControl"
                      (keyup.enter)="onFilterProducto()"
                      (keyup.tab)="onSearchPorCodigo()"
                      (focusin)="filtroProductoInput.select()"
                    />
                  </mat-form-field>
                </div>
              </span>
            </div>
            <div fxFlex="10">
              <span *ngIf="!filtroProductosOpen">
                <button mat-icon-button (click)="abrirFiltroProductos()">
                  <mat-icon>search</mat-icon>
                </button>
              </span>
              <span *ngIf="filtroProductosOpen">
                <button mat-icon-button (click)="abrirFiltroProductos()">
                  <mat-icon>clear</mat-icon>
                </button>
              </span>
            </div>
          </div>
        </th>
        <td mat-cell *matCellDef="let item" style="width: 30%">
          {{ item?.presentacionPreTransferencia?.producto?.id }} -
          {{
            item?.presentacionPreTransferencia?.producto?.descripcion
              | uppercase
          }}
        </td>
      </ng-container>

      <ng-container matColumnDef="codigo">
        <th mat-header-cell *matHeaderCellDef>Cod. Barra</th>
        <td mat-cell *matCellDef="let item">
          {{ item?.presentacionPreparacion?.producto?.codigoPrincipal }}
        </td>
      </ng-container>

      <ng-container matColumnDef="presentacion">
        <th mat-header-cell *matHeaderCellDef style="text-align: center">
          Presentacion
        </th>
        <td mat-cell *matCellDef="let item" style="text-align: center">
          {{ item?.presentacionPreparacion?.cantidad | number : "1.0-3" }}
        </td>
      </ng-container>

      <ng-container matColumnDef="cantidad">
        <th mat-header-cell *matHeaderCellDef style="text-align: center">
          Cantidad
        </th>
        <td mat-cell *matCellDef="let item" style="text-align: center">
          {{ item?.cantidadPreparacion | number : "1.0-3" }}
        </td>
      </ng-container>

      <ng-container matColumnDef="precio">
        <th mat-header-cell *matHeaderCellDef style="text-align: center">
          Precio venta
        </th>
        <td mat-cell *matCellDef="let item" style="text-align: center">
          {{
            item?.presentacionPreparacion?.precioPrincipal?.precio
              | number : "1.0-2"
          }}
        </td>
      </ng-container>

      <ng-container matColumnDef="vencimiento">
        <th mat-header-cell *matHeaderCellDef style="text-align: center">
          Vencimiento
        </th>
        <td
          mat-cell
          *matCellDef="let item"
          style="text-align: center; height: 100%"
        >
          <div
            fxLayout="row"
            style="width: 100%; height: 100%"
            fxLayoutGap="10px"
          >
            <div fxFlex>
              {{ item?.vencimientoPreparacion | date : "shortDate" }}
            </div>
          </div>
        </td>
      </ng-container>

      <ng-container matColumnDef="estado">
        <th mat-header-cell *matHeaderCellDef style="text-align: center">
          Estado
        </th>
        <td mat-cell *matCellDef="let item" style="text-align: center">
          {{
            item?.cantidadTransporte != null ||
            item?.vencimientoTransporte != null ||
            (item?.motivoRechazoTransporte != null && !isTransporteEnCamino)
              ? "Verificado"
              : "Falta verificar"
          }}
        </td>
      </ng-container>

      <ng-container matColumnDef="menu">
        <th
          mat-header-cell
          *matHeaderCellDef
          style="width: 5%; text-align: center"
        ></th>
        <td
          mat-cell
          *matCellDef="let item; let i = tabIndex"
          style="width: 5%; text-align: center"
        >
          <button
            mat-icon-button
            [matMenuTriggerFor]="menu"
            (click)="$event.stopPropagation()"
            [disabled]="!isTransporteVerificacion || !puedeEditar"
          >
            <mat-icon>more_vert</mat-icon>
          </button>
          <mat-menu #menu="matMenu">
            <button
              mat-menu-item
              *ngIf="
                item.cantidadTransporte == null &&
                item.vencimientoTransporte == null &&
                item.motivoRechazoTransporte == null
              "
              color="accent"
              (click)="onConfirm(item)"
            >
              Confirmar
            </button>
            <button
              mat-menu-item
              *ngIf="
                item.cantidadTransporte != null ||
                item.vencimientoTransporte != null ||
                item.motivoRechazoTransporte != null
              "
              color="primary"
              (click)="onDesconfirm(item)"
            >
              Desconfirmar
            </button>
            <button
              mat-menu-item
              (click)="onSolicitarModificarItem(item)"
              [disabled]="true"
            >
              Solicitar modificación
            </button>
            <button mat-menu-item (click)="onRechazar(item)">
              Rechazar item
            </button>
          </mat-menu>
        </td>
      </ng-container>

      <!-- Expanded Content Column - The detail row is made up of this one column that spans across all columns -->
      <ng-container matColumnDef="expandedDetail">
        <td
          mat-cell
          *matCellDef="let element"
          [attr.colspan]="columnsToDisplay.length"
        >
          <div
            class="example-element-detail"
            [@detailExpand]="
              element == expandedElement ? 'expanded' : 'collapsed'
            "
          ></div>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="columnsToDisplay"></tr>
      <tr
        mat-row
        *matRowDef="let element; columns: columnsToDisplay"
        class="example-element-row"
        [class.example-expanded-row]="expandedElement === element"
        (click)="expandedElement = expandedElement === element ? null : element"
        [class.sin-cambios]="
          element.cantidadTransporte != null &&
          element.motivoModificacionTransporte == null &&
          element.motivoRechazoTransporte == null &&
          !isTransporteEnCamino
        "
        [class.con-cambios]="
          element.motivoModificacionTransporte != null && !isTransporteEnCamino
        "
        [class.rechazado]="
          element.motivoRechazoTransporte != null && !isTransporteEnCamino
        "
      ></tr>
      <tr
        mat-row
        *matRowDef="let row; columns: ['expandedDetail']"
        class="example-detail-row"
      ></tr>
    </table>
    <table
      *ngIf="isRecepcionEnVerificacion || isRecepcionConcluida"
      mat-table
      [dataSource]="dataSource"
      multiTemplateDataRows
      class="mat-elevation-z8"
    >
      <ng-container matColumnDef="producto">
        <th mat-header-cell *matHeaderCellDef style="width: 30%">
          <div fxLayout="row" fxLayoutAlign="start space-between">
            <div fxFlex="90" fxLayout="column" fxLayoutAlign="center start">
              <span *ngIf="!filtroProductosOpen"> Producto </span>
              <span *ngIf="filtroProductosOpen" style="width: 100%">
                <div>
                  <mat-form-field
                    style="width: 100%"
                    appearance="outline"
                    class="shrinking-mat-form-field"
                  >
                    <input
                      #filtroProductoInput
                      matInput
                      type="text"
                      [formControl]="filtroProductoControl"
                      (keyup.enter)="onFilterProducto()"
                      (keyup.tab)="onSearchPorCodigo()"
                      (focusin)="filtroProductoInput.select()"
                    />
                  </mat-form-field>
                </div>
              </span>
            </div>
            <div fxFlex="10">
              <span *ngIf="!filtroProductosOpen">
                <button mat-icon-button (click)="abrirFiltroProductos()">
                  <mat-icon>search</mat-icon>
                </button>
              </span>
              <span *ngIf="filtroProductosOpen">
                <button mat-icon-button (click)="abrirFiltroProductos()">
                  <mat-icon>clear</mat-icon>
                </button>
              </span>
            </div>
          </div>
        </th>        <td mat-cell *matCellDef="let item" style="width: 30%">
          {{ item?.presentacionPreTransferencia?.producto?.id }} -
          {{
            item?.presentacionPreTransferencia?.producto?.descripcion
              | uppercase
          }}
        </td>
      </ng-container>

      <ng-container matColumnDef="codigo">
        <th mat-header-cell *matHeaderCellDef>Cod. Barra</th>
        <td mat-cell *matCellDef="let item">
          {{ item?.presentacionTransporte?.producto?.codigoPrincipal }}
        </td>
      </ng-container>

      <ng-container matColumnDef="presentacion">
        <th mat-header-cell *matHeaderCellDef style="text-align: center">
          Presentacion
        </th>
        <td mat-cell *matCellDef="let item" style="text-align: center">
          {{ item?.presentacionTransporte?.cantidad | number : "1.0-3" }}
        </td>
      </ng-container>

      <ng-container matColumnDef="cantidad">
        <th mat-header-cell *matHeaderCellDef style="text-align: center">
          Cantidad
        </th>
        <td mat-cell *matCellDef="let item" style="text-align: center">
          {{ item?.cantidadTransporte | number : "1.0-3" }}
        </td>
      </ng-container>

      <ng-container matColumnDef="precio">
        <th mat-header-cell *matHeaderCellDef style="text-align: center">
          Precio venta
        </th>
        <td mat-cell *matCellDef="let item" style="text-align: center">
          {{
            item?.presentacionTransporte?.precioPrincipal?.precio
              | number : "1.0-2"
          }}
        </td>
      </ng-container>

      <ng-container matColumnDef="vencimiento">
        <th mat-header-cell *matHeaderCellDef style="text-align: center">
          Vencimiento
        </th>
        <td
          mat-cell
          *matCellDef="let item"
          style="text-align: center; height: 100%"
        >
          <div
            fxLayout="row"
            style="width: 100%; height: 100%"
            fxLayoutGap="10px"
          >
            <div fxFlex>
              {{ item?.vencimientoTransporte | date : "shortDate" }}
            </div>
          </div>
        </td>
      </ng-container>

      <ng-container matColumnDef="estado">
        <th mat-header-cell *matHeaderCellDef style="text-align: center">
          Estado
        </th>
        <td mat-cell *matCellDef="let item" style="text-align: center">
          {{
            item?.cantidadRecepcion != null ||
            item?.vencimientoRecepcion != null ||
            item?.motivoRechazoRecepcion != null
              ? "Verificado"
              : "Falta verificar"
          }}
        </td>
      </ng-container>

      <ng-container matColumnDef="menu">
        <th
          mat-header-cell
          *matHeaderCellDef
          style="width: 5%; text-align: center"
        ></th>
        <td
          mat-cell
          *matCellDef="let item; let i = tabIndex"
          style="width: 5%; text-align: center"
        >
          <button
            mat-icon-button
            [matMenuTriggerFor]="menu"
            (click)="$event.stopPropagation()"
            [disabled]="!isRecepcionEnVerificacion && !isDestino"
          >
            <mat-icon>more_vert</mat-icon>
          </button>
          <mat-menu #menu="matMenu">
            <button
              mat-menu-item
              *ngIf="
                item.cantidadRecepcion == null &&
                item.vencimientoRecepcion == null &&
                item.motivoRechazoRecepcion == null
              "
              color="accent"
              (click)="onConfirm(item)"
            >
              Confirmar
            </button>
            <button
              mat-menu-item
              *ngIf="
                item.cantidadRecepcion != null ||
                item.vencimientoRecepcion != null ||
                item.motivoRechazoRecepcion != null
              "
              color="primary"
              (click)="onDesconfirm(item)"
            >
              Desconfirmar
            </button>
            <button
              mat-menu-item
              (click)="onSolicitarModificarItem(item)"
              [disabled]="true"
            >
              Solicitar modificación
            </button>
            <button mat-menu-item (click)="onRechazar(item)">
              Rechazar item
            </button>
          </mat-menu>
        </td>
      </ng-container>

      <!-- Expanded Content Column - The detail row is made up of this one column that spans across all columns -->
      <ng-container matColumnDef="expandedDetail">
        <td
          mat-cell
          *matCellDef="let element"
          [attr.colspan]="columnsToDisplay.length"
        >
          <div
            class="example-element-detail"
            [@detailExpand]="
              element == expandedElement ? 'expanded' : 'collapsed'
            "
          ></div>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="columnsToDisplay"></tr>
      <tr
        mat-row
        *matRowDef="let element; columns: columnsToDisplay"
        class="example-element-row"
        [class.example-expanded-row]="expandedElement === element"
        (click)="expandedElement = expandedElement === element ? null : element"
        [class.sin-cambios]="
          element.cantidadRecepcion != null &&
          element.motivoModificacionRecepcion == null &&
          element.motivoRechazoRecepcion == null
        "
        [class.con-cambios]="element.motivoModificacionRecepcion != null"
        [class.rechazado]="element.motivoRechazoRecepcion != null"
      ></tr>
      <tr
        mat-row
        *matRowDef="let row; columns: ['expandedDetail']"
        class="example-detail-row"
      ></tr>
    </table>
    <mat-paginator
      itemsPerPageLabel="Itens por pagina"
      [pageSizeOptions]="[15, 25, 50, 100]"
      (page)="handlePageEvent($event)"
      [length]="selectedPageInfo?.getTotalElements"
      style="width: 100%"
      showFirstLastButtons
    ></mat-paginator>
  </div>
</app-generic-list>
