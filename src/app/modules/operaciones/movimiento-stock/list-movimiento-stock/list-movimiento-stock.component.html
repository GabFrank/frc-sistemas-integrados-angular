<app-generic-list
  [data]="dataSource.data"
  (filtrar)="onFiltrar()"
  (resetFiltro)="resetFiltro()"
  [isCustom]="true"
  customName="Generar Pdf"
  (customFunction)="onGenerarPdf()"
>
  <div filtros fxLayout="column" fxLayoutGap="20px">
    <div
      fxLayout="row"
      fxLayoutAlign="start center"
      fxLayoutGap="10px"
      style="width: 100%"
    >
      <div fxFlex="30%">
        <mat-form-field style="width: 100%">
          <mat-label>Rango de fecha</mat-label>
          <mat-date-range-input
            [formGroup]="fechaFormGroup"
            [rangePicker]="picker"
            style="width: 100%"
          >
            <input
              matStartDate
              formControlName="inicio"
              placeholder="Inicio"
              [max]="today"
            />
            <input
              matEndDate
              formControlName="fin"
              placeholder="Fin"
              [max]="fechaInicioControl.value"
            />
          </mat-date-range-input>
          <mat-datepicker-toggle
            matSuffix
            [for]="picker"
          ></mat-datepicker-toggle>
          <mat-date-range-picker #picker></mat-date-range-picker>

          <mat-error
            *ngIf="
              fechaFormGroup.controls.inicio.hasError('matStartDateInvalid')
            "
            >Fecha inicial inválida</mat-error
          >
          <mat-error
            *ngIf="fechaFormGroup.controls.fin.hasError('matEndDateInvalid')"
            >Fecha final inválida</mat-error
          >
          <mat-hint
            fxLayout="row"
            fxLayoutAlign="space-around center"
            style="padding-top: 5px; padding-bottom: 5px; width: 100%"
          >
            <mat-chip-listbox style="width: 100%">
              <mat-chip-option
                style="height: 15px"
                (click)="cambiarFecha('dia')"
                multiple="false"
                >7 días</mat-chip-option
              >
              <mat-chip-option
                style="height: 15px"
                (click)="cambiarFecha('mes')"
                >1 me</mat-chip-option
              >
              <mat-chip-option
                style="height: 15px"
                (click)="cambiarFecha('2mes')"
                >-1 me</mat-chip-option
              >
              <mat-chip-option
                style="height: 15px"
                (click)="cambiarFecha('3mes')"
                >3 me</mat-chip-option
              >
            </mat-chip-listbox>
          </mat-hint>
        </mat-form-field>
      </div>
      <div fxFlex="7%">
        <mat-form-field style="width: 100%">
          <mat-label>Inicio Hora</mat-label>
          <input
            matInput
            [formControl]="horaInicioControl"
            type="time"
            placeholder="Hora inicio"
          />
        </mat-form-field>
      </div>
      <div fxFlex="7%">
        <mat-form-field style="width: 100%">
          <mat-label>Fin Hora</mat-label>
          <input
            matInput
            [formControl]="horaFinalControl"
            type="time"
            placeholder="Hora fin"
          />
        </mat-form-field>
      </div>
      <div fxFlex="20%">
        <mat-form-field
          style="width: 100%"
          [matTooltip]="sucursalControl.value"
        >
          <mat-label>Sucursales</mat-label>
          <mat-select #sucursalSelect [formControl]="sucursalControl" multiple>
            <mat-select-trigger>
              {{(sucursalControl.value?.[0]?.nombre || '')}}
              <span
                *ngIf="(sucursalControl.value?.length || 0) > 1"
                class="example-additional-selection"
              >
                (+{{ (sucursalControl.value?.length || 0) - 1 }}
                {{ sucursalControl.value?.length === 2 ? "otro" : "otros" }})
              </span>
            </mat-select-trigger>
            <div
              style="
                width: 100%;
                text-align: end;
                padding-right: 10px;
                padding-top: 10px;
                font-size: 0.8em;
                color: white;
              "
            >
              <mat-icon (click)="sucursalSelect.close()">clear</mat-icon>
            </div>
            <mat-option [value]="null">Todas</mat-option>
            <mat-option *ngFor="let sucursal of sucursalList" [value]="sucursal"
              >{{ sucursal?.id }} -
              {{ sucursal?.nombre | titlecase }}</mat-option
            >
          </mat-select>
        </mat-form-field>
      </div>
      <div fxFlex="40%" fxLayout="column" fxLayoutGap="10px">
        <div fxFlex fxLayoutAlign="start center">
          <div fxFlex="80%">
            <mat-form-field style="width: 100%">
              <mat-label>Buscar producto</mat-label>
              <input
                #buscadorInput
                type="text"
                matInput
                [formControl]="buscarProductoControl"
                (keyup.enter)="onBuscarProducto()"
              />
            </mat-form-field>
          </div>
          <div fxFlex="10%" style="text-align: center">
            <mat-icon style="font-size: 2em" (click)="onBuscarProducto()"
              >search</mat-icon
            >
          </div>
          <div fxFlex="10%" style="text-align: center">
            <mat-icon style="font-size: 2em" (click)="onAddProducto()"
              >add</mat-icon
            >
          </div>
        </div>
        <div
          fxFlex
          fxLayout="row"
          *ngFor="let producto of productoList; let index = index"
        >
          <div fxFlex="80%">{{ producto.id }} - {{ producto.descripcion }}</div>
          <div fxFlex="10%" style="text-align: center">
            <mat-icon
              style="font-size: 2em"
              (click)="onClearProducto(producto, index)"
              >clear</mat-icon
            >
          </div>
        </div>
      </div>
    </div>
    <div
      fxLayout="row"
      fxLayoutAlign="start center"
      fxLayoutGap="10px"
      style="width: 100%; padding-top: 30px"
    >
      <div fxFlex="20%">
        <mat-form-field
          style="width: 100%"
          [matTooltip]="tipoMovimientoControl.value"
        >
          <mat-label>Tipo de movimiento</mat-label>
          <mat-select
            #sucursalSelect
            [formControl]="tipoMovimientoControl"
            multiple
          >
            <mat-select-trigger>
              {{ tipoMovimientoControl.value }}
              <span
                *ngIf="(tipoMovimientoControl.value?.length || 0) > 1"
                class="example-additional-selection"
              >
                (+{{ (tipoMovimientoControl.value?.length || 0) - 1 }}
                {{
                  tipoMovimientoControl.value?.length === 2 ? "otro" : "otros"
                }})
              </span>
            </mat-select-trigger>
            <div
              style="
                width: 100%;
                text-align: end;
                padding-right: 10px;
                padding-top: 10px;
                font-size: 0.8em;
                color: white;
              "
            >
              <mat-icon (click)="sucursalSelect.close()">clear</mat-icon>
            </div>
            <mat-option value="Todas">Todas</mat-option>
            <mat-option
              *ngFor="let tipoMovimiento of tipoMovimientoList"
              [value]="tipoMovimiento"
              >{{ tipoMovimiento }}</mat-option
            >
          </mat-select>
        </mat-form-field>
      </div>
      <div fxFlex="30%" fxLayout="row" fxLayoutAlign="start center">
        <div fxFlex="80%">
          <mat-form-field style="width: 100%">
            <mat-label>Buscar usuario</mat-label>
            <input
              #usuarioInput
              type="text"
              matInput
              [formControl]="buscarUsuarioControl"
              (keyup.enter)="onBuscarUsuario()"
            />
          </mat-form-field>
        </div>
        <div fxFlex="10%" style="text-align: center">
          <mat-icon style="font-size: 2em" (click)="onBuscarUsuario()"
            >search</mat-icon
          >
        </div>
        <div
          fxFlex="10%"
          style="text-align: center"
          *ngIf="selectedUsuario != null"
        >
          <mat-icon style="font-size: 2em" (click)="onClearUsuario()"
            >clear</mat-icon
          >
        </div>
      </div>
    </div>
  </div>
  <div
    table
    style="height: 100%; background-color: rgb(70, 70, 70)"
    fxLayout="column"
    fxLayoutAlign="space-between start"
  >
    <table
      mat-table
      [dataSource]="dataSource"
      multiTemplateDataRows
      class="mat-elevation-z8"
      style="width: 100%"
    >
      <ng-container matColumnDef="id" style="width: 5%">
        <th mat-header-cell *matHeaderCellDef style="text-align: center">Id</th>
        <td mat-cell *matCellDef="let movimiento" style="text-align: center">
          {{ movimiento.id }}
        </td>
      </ng-container>

      <!-- Name Column -->
      <ng-container matColumnDef="producto">
        <th mat-header-cell *matHeaderCellDef>Producto</th>
        <td mat-cell *matCellDef="let movimiento" style="text-align: start">
          {{ movimiento?.producto?.descripcion | uppercase }}
        </td>
      </ng-container>

      <ng-container matColumnDef="cantidad">
        <th mat-header-cell *matHeaderCellDef style="text-align: center">
          Cantidad
        </th>
        <td mat-cell *matCellDef="let movimiento" style="text-align: center">
          {{ movimiento?.cantidad | number : "1.0-2" }}
        </td>
      </ng-container>

      <ng-container matColumnDef="tipo">
        <th mat-header-cell *matHeaderCellDef style="text-align: center">
          Tipo
        </th>
        <td mat-cell *matCellDef="let movimiento" style="text-align: center">
          {{ movimiento?.tipoMovimiento | titlecase }}
        </td>
      </ng-container>

      <ng-container matColumnDef="estado">
        <th mat-header-cell *matHeaderCellDef style="text-align: center">
          Estado
        </th>
        <td mat-cell *matCellDef="let movimiento" style="text-align: center">
          {{ movimiento?.estado ? "Activo" : "Inactivo" }}
        </td>
      </ng-container>

      <ng-container matColumnDef="fecha">
        <th mat-header-cell *matHeaderCellDef style="text-align: center">
          Fecha
        </th>
        <td mat-cell *matCellDef="let movimiento" style="text-align: center">
          {{ movimiento?.creadoEn }}
        </td>
      </ng-container>

      <ng-container matColumnDef="acciones">
        <th
          mat-header-cell
          *matHeaderCellDef
          style="width: 5%; text-align: center"
        >
          ...
        </th>
        <td
          mat-cell
          *matCellDef="let movimiento"
          style="text-align: center; width: 5%"
        >
          <button
            mat-icon-button
            [matMenuTriggerFor]="menu"
            (click)="$event.stopPropagation()"
          >
            <mat-icon>more_vert</mat-icon>
          </button>
          <mat-menu #menu="matMenu">
            <button mat-menu-item (click)="onReferenciaClick(movimiento)">
              Ir a {{ movimiento?.tipoMovimiento | titlecase }}
            </button>
          </mat-menu>
        </td>
      </ng-container>

      <mat-divider></mat-divider>

      <!-- Expanded Content Column - The detail row is made up of this one column that spans across all columns -->
      <ng-container matColumnDef="expandedDetail">
        <td
          mat-cell
          *matCellDef="let movimiento"
          [attr.colspan]="displayedColumns.length"
          class="expanded"
        >
          <div
            class="example-movimiento-detail"
            [@detailExpand]="
              movimiento == expandedMovimiento ? 'expanded' : 'collapsed'
            "
            style="text-align: center"
            fxLayout="column"
            fxLayoutAlign="start start"
          ></div>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"></tr>
      <tr
        mat-row
        *matRowDef="let row; columns: displayedColumns; let i = dataIndex"
      ></tr>
      <tr
        mat-row
        *matRowDef="let row; columns: ['expandedDetail']"
        class="example-detail-row"
      ></tr>
    </table>
    <mat-paginator
      itemsPerPageLabel="Itens por pagina"
      [pageSizeOptions]="[15, 25, 50, 100]"
      (page)="handlePageEvent($event)"
      [length]="selectedPageInfo?.getTotalElements"
      style="width: 100%"
      showFirstLastButtons
    ></mat-paginator>
  </div>
</app-generic-list>
